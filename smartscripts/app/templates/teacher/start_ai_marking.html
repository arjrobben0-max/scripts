{% extends "teacher/base.html" %}

{% block title %}Start AI Marking{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="text-center">
    <h2 class="mb-4 text-success">âœ… Test Materials Uploaded Successfully!</h2>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">
          {% for message in messages %}
            <div>{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <p class="lead">You're all set to begin <strong>AI-powered marking</strong> of student submissions.</p>

    <!-- ðŸš€ Start OCR Button -->
    <button onclick="startOCR({{ test_id }})" class="btn btn-success btn-lg mt-3 rounded-pill shadow-sm">
      ðŸš€ Start AI Marking
    </button>

    <!-- Progress Bar Section -->
    <div id="ocr-progress-container" class="mt-5" style="display: none;">
      <div class="progress" style="height: 30px;">
        <div id="ocr-progress-bar"
             class="progress-bar progress-bar-striped progress-bar-animated"
             role="progressbar"
             style="width: 0%">
          0%
        </div>
      </div>
    </div>

    <!-- ðŸ‘€ View Extracted Button -->
    <div id="ocr-complete-controls" class="mt-4" style="display: none;">
      <a id="view-extracted-btn" href="#" class="btn btn-primary px-4 rounded-pill">
        ðŸ‘€ View Extracted Scripts
      </a>
    </div>

    <!-- ðŸ”™ Back to Dashboard -->
    <div class="mt-4">
      <a href="{{ url_for('teacher_bp.dashboard_bp.dashboard') }}" class="btn btn-outline-secondary rounded-pill">â† Back to Dashboard</a>
    </div>
  </div>
</div>

<!-- JavaScript for Polling OCR Task -->
<script>
function pollOCRStatus(taskId, testId) {
  const progressBar = document.getElementById('ocr-progress-bar');
  const container = document.getElementById('ocr-progress-container');
  const completeControls = document.getElementById('ocr-complete-controls');
  const viewBtn = document.getElementById('view-extracted-btn');

  container.style.display = 'block';

  function updateStatus() {
    fetch("{{ url_for('teacher_bp.task_status', task_id='') }}" + taskId)
      .then(response => response.json())
      .then(data => {
        if (data.state === 'PROGRESS') {
          const percent = data.status.progress || 0;
          progressBar.style.width = percent + '%';
          progressBar.innerText = percent + '%';
          setTimeout(updateStatus, 1000);
        } else if (data.state === 'SUCCESS') {
          progressBar.style.width = '100%';
          progressBar.innerText = 'âœ… Complete';
          viewBtn.href = "{{ url_for('teacher_bp.review_extracted_list', test_id='') }}" + testId;
          completeControls.style.display = 'block';
          setTimeout(() => {
            window.location.href = "{{ url_for('teacher_bp.review_extracted_list', test_id='') }}" + testId;
          }, 5000);
        } else if (data.state === 'FAILURE') {
          progressBar.classList.add('bg-danger');
          progressBar.innerText = 'âŒ Failed';
        }
      });
  }

  updateStatus();
}

function startOCR(testId) {
  fetch("{{ url_for('teacher_bp.run_ocr', test_id='') }}" + testId, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      pollOCRStatus(data.task_id, testId);
    });
}
</script>
{% endblock %}



