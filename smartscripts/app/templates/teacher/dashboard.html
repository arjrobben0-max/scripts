{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Dashboard</h2>

  <!-- Create Test Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header">
      <h5 class="mb-0">Create a New Test</h5>
    </div>
    <div class="card-body">
      <!-- ✅ Fixed endpoint -->
      <form method="GET" action="{{ url_for('manage_bp.list_tests') }}">
        {{ form.hidden_tag() }}

        <div class="mb-3">
          {{ form.test_title.label(class="form-label") }}
          {{ form.test_title(class="form-control", placeholder="Enter test title") }}
          {% for error in form.test_title.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          {{ form.subject.label(class="form-label") }}
          {{ form.subject(class="form-control") }}
          {% for error in form.subject.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          {{ form.grade_level.label(class="form-label") }}
          {{ form.grade_level(class="form-control") }}
          {% for error in form.grade_level.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          {{ form.exam_date.label(class="form-label") }}
          {{ form.exam_date(class="form-control") }}
          {% for error in form.exam_date.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          {{ form.description.label(class="form-label") }}
          {{ form.description(class="form-control", rows="3") }}
          {% for error in form.description.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-success">Create Test</button>
      </form>
    </div>
  </div>

  <!-- Uploaded Tests Section -->
  <h3 class="mb-3">Uploaded Tests</h3>

  <!-- Controls -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <button id="toggleView" class="btn btn-outline-secondary btn-sm" aria-pressed="false">
        Toggle View
      </button>
      <button id="darkToggle" class="btn btn-outline-dark btn-sm" aria-pressed="false">
        Dark Mode
      </button>
    </div>
    <div>
      <select onchange="filterTests(this.value)" class="form-select form-select-sm">
        <option value="all">Show All</option>
        <option value="complete">Complete</option>
        <option value="incomplete">Incomplete</option>
      </select>
    </div>
  </div>

  <!-- Table View -->
  <table id="testsTable" class="table table-striped table-bordered" style="width:100%">
    <thead>
      <tr>
        <th>Title</th>
        <th>Subject</th>
        <th>Grade</th>
        <th>Created</th>
        <th>Question Paper</th>
        <th>Rubric</th>
        <th>Marking Guide</th>
        <th>Answered Script</th>
        <th>Class List</th>
        <th>Combined Scripts</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for test in uploaded_tests %}
      <tr data-status="{{ 'complete' if test.question_paper_path and test.rubric_path and test.marking_guide_path and test.class_list_path and test.combined_scripts_path else 'incomplete' }}">
        <td>{{ test.test_title }}</td>
        <td>{{ test.subject }}</td>
        <td>{{ test.grade_level }}</td>
        <td>{{ test.created_at.strftime('%Y-%m-%d') if test.created_at else '-' }}</td>

        <td><button class="{{ 'btn-uploaded' if test.question_paper_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.question_paper_path else 'Not Uploaded' }}</button></td>
        <td><button class="{{ 'btn-uploaded' if test.rubric_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.rubric_path else 'Not Uploaded' }}</button></td>
        <td><button class="{{ 'btn-uploaded' if test.marking_guide_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.marking_guide_path else 'Not Uploaded' }}</button></td>
        <td><button class="{{ 'btn-uploaded' if test.answered_script_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.answered_script_path else 'Not Uploaded' }}</button></td>
        <td><button class="{{ 'btn-uploaded' if test.class_list_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.class_list_path else 'Not Uploaded' }}</button></td>
        <td><button class="{{ 'btn-uploaded' if test.combined_scripts_path else 'btn-not-uploaded' }}" disabled>{{ 'Uploaded' if test.combined_scripts_path else 'Not Uploaded' }}</button></td>

        <td>
          <a href="{{ url_for('manage_bp.manage_test_files', test_id=test.id) }}"
             class="btn btn-primary btn-sm"
             aria-label="Manage {{ test.test_title }}">
            Manage
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="11" class="text-center">No uploaded tests found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Card View -->
  <div id="cardContainer" class="mt-4" aria-live="polite" aria-atomic="true">
    {% for test in uploaded_tests %}
      {% set file_map = {
        'question_paper': test.question_paper_path,
        'rubric': test.rubric_path,
        'marking_guide': test.marking_guide_path,
        'answered_script': test.answered_script_path,
        'class_list': test.class_list_path,
        'combined_scripts': test.combined_scripts_path
      } %}
      {% set uploaded_count = file_map.values() | select | list | length %}
      {% set complete = uploaded_count == file_map | length %}

      {% set tooltip_text = "" %}
      {% for ftype, fpath in file_map.items() %}
        {% set tooltip_text = tooltip_text + ftype.replace('_', ' ').title() + ': ' + ('✓ Uploaded' if fpath else '✗ Missing') + '\n' %}
      {% endfor %}

      <div class="test-card" data-status="{{ 'complete' if complete else 'incomplete' }}"
           role="region" aria-label="Test card for {{ test.test_title }}">
        <h5>{{ test.test_title }}</h5>
        <div><strong>Subject:</strong> {{ test.subject }}</div>
        <div><strong>Grade:</strong> {{ test.grade_level }}</div>
        <div><strong>Created:</strong> {{ test.created_at.strftime('%Y-%m-%d') if test.created_at else '-' }}</div>
        <span class="badge {{ 'bg-success' if complete else 'bg-warning text-dark' }}"
              data-bs-toggle="tooltip" data-bs-html="true"
              title="{{ tooltip_text | safe }}">
          {{ 'Complete' if complete else 'Incomplete' }}
        </span>
        <div class="progress mb-3 mt-2" aria-label="Upload progress">
          <div class="progress-bar {{ 'bg-success' if complete else 'bg-warning' }}"
               role="progressbar"
               style="width: {{ (uploaded_count / (file_map|length) * 100) | round(0) }}%"
               aria-valuenow="{{ (uploaded_count / (file_map|length) * 100) | round(0) }}"
               aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
        <div class="actions">
          <a href="{{ url_for('manage_bp.manage_test_files', test_id=test.id) }}"
             class="btn btn-primary btn-sm"
             aria-label="Manage {{ test.test_title }}">
            Manage
          </a>
        </div>
      </div>
    {% else %}
      <p class="text-center">No uploaded tests found.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function() {
    if (!$.fn.DataTable.isDataTable('#testsTable')) {
      $('#testsTable').DataTable({
        responsive: true,
        dom: 'Bfrtip',
        buttons: ['csv', 'excel']
      });
    }

    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
  });

  const darkToggleBtn = document.getElementById('darkToggle');
  const body = document.body;

  function setDarkMode(enabled) {
    if (enabled) {
      body.classList.add('dark-mode');
      localStorage.setItem('darkMode', 'true');
      darkToggleBtn.setAttribute('aria-pressed', 'true');
    } else {
      body.classList.remove('dark-mode');
      localStorage.setItem('darkMode', 'false');
      darkToggleBtn.setAttribute('aria-pressed', 'false');
    }
  }

  darkToggleBtn.addEventListener('click', () => {
    setDarkMode(!body.classList.contains('dark-mode'));
  });

  if (localStorage.getItem('darkMode') === 'true') {
    setDarkMode(true);
  }

  function filterTests(status) {
    document.querySelectorAll('#testsTable tbody tr').forEach(row => {
      row.style.display = (status === 'all' || row.dataset.status === status) ? '' : 'none';
    });
    document.querySelectorAll('#cardContainer .test-card').forEach(card => {
      card.style.display = (status === 'all' || card.dataset.status === status) ? '' : 'none';
    });
  }

  const toggleViewBtn = document.getElementById('toggleView');
  const cardContainer = document.getElementById('cardContainer');
  const testsTable = document.getElementById('testsTable');

  function setView(view) {
    if (view === 'card') {
      cardContainer.classList.add('active');
      testsTable.style.display = 'none';
      localStorage.setItem('dashboardView', 'card');
      toggleViewBtn.setAttribute('aria-pressed', 'true');
    } else {
      cardContainer.classList.remove('active');
      testsTable.style.display = '';
      localStorage.setItem('dashboardView', 'table');
      toggleViewBtn.setAttribute('aria-pressed', 'false');
    }
  }

  toggleViewBtn.addEventListener('click', () => {
    const isCard = cardContainer.classList.contains('active');
    setView(isCard ? 'table' : 'card');
  });

  const savedView = localStorage.getItem('dashboardView') || 'table';
  setView(savedView);
</script>
{% endblock %}
