{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">📘 Teacher Dashboard</h2>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Create Test Form -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">🧾 Create a New Test</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('manage_bp.list_tests') }}" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="row g-3">
          <div class="col-md-6">
            {{ form.test_title.label(class="form-label") }}
            {{ form.test_title(class="form-control", placeholder="Enter test title") }}
          </div>
          <div class="col-md-6">
            {{ form.subject.label(class="form-label") }}
            {{ form.subject(class="form-select") }}
          </div>
          <div class="col-md-6">
            {{ form.grade_level.label(class="form-label") }}
            {{ form.grade_level(class="form-select") }}
          </div>
          <div class="col-md-6">
            {{ form.exam_date.label(class="form-label") }}
            {{ form.exam_date(class="form-control") }}
          </div>
          <div class="col-12">
            {{ form.description.label(class="form-label") }}
            {{ form.description(class="form-control", rows="3") }}
          </div>

          <!-- File uploads -->
          <div class="col-md-6">
            {{ form.question_paper.label(class="form-label") }}
            {{ form.question_paper(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.marking_guide.label(class="form-label") }}
            {{ form.marking_guide(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.rubric.label(class="form-label") }}
            {{ form.rubric(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.answered_script.label(class="form-label") }}
            {{ form.answered_script(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.class_list.label(class="form-label") }}
            {{ form.class_list(class="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.combined_scripts.label(class="form-label") }}
            {{ form.combined_scripts(class="form-control") }}
          </div>
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-success">{{ form.submit.label.text }}</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Uploaded Tests -->
  <h3 class="mb-3">📂 Uploaded Tests</h3>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <button id="toggleView" class="btn btn-outline-secondary btn-sm" aria-pressed="false">Toggle View</button>
      <button id="darkToggle" class="btn btn-outline-dark btn-sm" aria-pressed="false">Dark Mode</button>
    </div>
    <div>
      <select onchange="filterTests(this.value)" class="form-select form-select-sm">
        <option value="all">Show All</option>
        <option value="complete">Complete</option>
        <option value="incomplete">Incomplete</option>
      </select>
    </div>
  </div>

  <!-- Table View -->
  <table id="testsTable" class="table table-striped table-bordered align-middle w-100">
    <thead class="table-light">
      <tr>
        <th>Title</th>
        <th>Subject</th>
        <th>Grade</th>
        <th>Created</th>
        <th>Question Paper</th>
        <th>Rubric</th>
        <th>Marking Guide</th>
        <th>Answered Script</th>
        <th>Class List</th>
        <th>Combined Scripts</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for test in uploaded_tests %}
      <tr data-status="{{ 'complete' if test.question_paper_path and test.marking_guide_path and test.combined_scripts_path else 'incomplete' }}">
        <td>{{ test.title }}</td>
        <td>{{ test.subject }}</td>
        <td>{{ test.grade_level }}</td>
        <td>{{ test.created_at.strftime('%Y-%m-%d') if test.created_at else '-' }}</td>
        <td>{{ '✅' if test.question_paper_path else '❌' }}</td>
        <td>{{ '✅' if test.rubric_path else '❌' }}</td>
        <td>{{ '✅' if test.marking_guide_path else '❌' }}</td>
        <td>{{ '✅' if test.answered_script_path else '❌' }}</td>
        <td>{{ '✅' if test.class_list_path else '❌' }}</td>
        <td>{{ '✅' if test.combined_scripts_path else '❌' }}</td>
        <td>
          <a href="{{ url_for('manage_bp.manage_test_files', test_id=test.id) }}" class="btn btn-sm btn-primary">Manage</a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="11" class="text-center text-muted">No uploaded tests found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Card View -->
  <div id="cardContainer" class="mt-4">
    {% for test in uploaded_tests %}
      {% set complete = test.question_paper_path and test.marking_guide_path and test.combined_scripts_path %}
      <div class="test-card p-3 mb-3 shadow-sm rounded" data-status="{{ 'complete' if complete else 'incomplete' }}">
        <h5>{{ test.title }}</h5>
        <p><strong>Subject:</strong> {{ test.subject }}</p>
        <p><strong>Grade:</strong> {{ test.grade_level }}</p>
        <p><strong>Created:</strong> {{ test.created_at.strftime('%Y-%m-%d') if test.created_at else '-' }}</p>
        <span class="badge {{ 'bg-success' if complete else 'bg-warning text-dark' }}">{{ 'Complete' if complete else 'Incomplete' }}</span>
        <div class="mt-2">
          <a href="{{ url_for('manage_bp.manage_test_files', test_id=test.id) }}" class="btn btn-primary btn-sm">Manage</a>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function () {
  // ✅ Initialize DataTable only once
  if (!$.fn.DataTable.isDataTable('#testsTable')) {
    $('#testsTable').DataTable({
      responsive: true,
      dom: 'Bfrtip',
      buttons: ['csv', 'excel']
    });
  }

  // Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

  // Dark mode toggle
  const darkToggleBtn = document.getElementById('darkToggle');
  const body = document.body;
  function setDarkMode(enabled) {
    if (enabled) {
      body.classList.add('dark-mode');
      localStorage.setItem('darkMode', 'true');
      darkToggleBtn.setAttribute('aria-pressed', 'true');
    } else {
      body.classList.remove('dark-mode');
      localStorage.setItem('darkMode', 'false');
      darkToggleBtn.setAttribute('aria-pressed', 'false');
    }
  }
  darkToggleBtn.addEventListener('click', () => {
    setDarkMode(!body.classList.contains('dark-mode'));
  });
  if (localStorage.getItem('darkMode') === 'true') setDarkMode(true);

  // View toggle (card/table)
  const toggleViewBtn = document.getElementById('toggleView');
  const cardContainer = document.getElementById('cardContainer');
  const testsTable = document.getElementById('testsTable');
  function setView(view) {
    if (view === 'card') {
      cardContainer.style.display = '';
      testsTable.style.display = 'none';
      localStorage.setItem('dashboardView', 'card');
      toggleViewBtn.setAttribute('aria-pressed', 'true');
    } else {
      cardContainer.style.display = 'none';
      testsTable.style.display = '';
      localStorage.setItem('dashboardView', 'table');
      toggleViewBtn.setAttribute('aria-pressed', 'false');
    }
  }
  toggleViewBtn.addEventListener('click', () => {
    const isCard = cardContainer.style.display !== 'none';
    setView(isCard ? 'table' : 'card');
  });
  setView(localStorage.getItem('dashboardView') || 'table');
});

// Filter tests by status
function filterTests(status) {
  document.querySelectorAll('#testsTable tbody tr').forEach(row => {
    row.style.display = (status === 'all' || row.dataset.status === status) ? '' : 'none';
  });
  document.querySelectorAll('#cardContainer .test-card').forEach(card => {
    card.style.display = (status === 'all' || card.dataset.status === status) ? '' : 'none';
  });
}
</script>
{% endblock %}
