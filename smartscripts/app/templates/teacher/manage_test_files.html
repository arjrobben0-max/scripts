{% extends "base.html" %}
{% block title %}Manage Test Files & Front Page Review{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="mb-3">
    📂 Manage & Review Files for Test:
    <span class="text-primary">{{ test.title }}</span>
  </h2>
  <p class="text-muted">Upload, delete, or review OCR-detected student front pages.</p>
  <hr>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- FILE MANAGEMENT SECTION -->
  <h4 class="mt-4">📁 Test File Management</h4>
  <div class="row mt-3">
    {% for key, label in file_types %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <h5 class="card-title text-secondary">{{ label }}</h5>
              {% if file_urls[key] %}
                <p class="text-success fw-bold">✅ File uploaded</p>
                <div class="d-flex gap-2">
                  <a href="{{ file_urls[key] }}" target="_blank"
                     class="btn btn-sm btn-outline-primary flex-fill">View</a>
                  <form method="POST"
                        action="{{ url_for('manage_bp.delete_file', test_id=test.id, file_type=key) }}"
                        onsubmit="return confirm('Are you sure you want to delete this file?');">
                    {{ delete_forms[key].hidden_tag() }}
                    <button type="submit" class="btn btn-sm btn-outline-danger flex-fill">Delete</button>
                  </form>
                </div>
              {% else %}
                <p class="text-muted">📭 No file uploaded yet</p>
                <form method="POST" enctype="multipart/form-data"
                      action="{{ url_for('manage_bp.upload_file_route', test_id=test.id, file_type=key) }}">
                  {{ upload_forms[key].hidden_tag() }}
                  <div class="input-group input-group-sm">
                    {{ upload_forms[key].file(class="form-control") }}
                    <button type="submit" class="btn btn-success">Upload</button>
                  </div>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <hr>

  <!-- PREPROCESSING SECTION -->
  <h4 class="mt-4">⚙️ OCR Preprocessing</h4>
  <form method="POST" action="{{ url_for('manage_bp.start_preprocessing', test_id=test.id) }}">
    {{ preprocessing_form.hidden_tag() }}
    <button type="submit" class="btn btn-primary">Start OCR Preprocessing</button>
  </form>

  {% if test.ocr_task_id %}
  <!-- TASK CONTROLS -->
  <div class="mt-3">
    <form method="POST" action="{{ url_for('manage_bp.pause_task', task_id=test.ocr_task_id) }}" class="d-inline">
      <button class="btn btn-warning btn-sm">⏸ Pause</button>
    </form>
    <form method="POST" action="{{ url_for('manage_bp.resume_task', task_id=test.ocr_task_id) }}" class="d-inline">
      <button class="btn btn-success btn-sm">▶ Resume</button>
    </form>
    <form method="POST" action="{{ url_for('manage_bp.cancel_task', task_id=test.ocr_task_id) }}" class="d-inline">
      <button class="btn btn-danger btn-sm">❌ Cancel</button>
    </form>
  </div>

  <!-- TASK PROGRESS -->
  <div class="mt-3">
    <h5>OCR Progress</h5>
    <div class="progress" style="height: 25px;">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%">0%</div>
    </div>
  </div>

  <script>
    function updateProgress() {
      fetch("{{ url_for('manage_bp.task_status', task_id=test.ocr_task_id) }}")
        .then(r => r.json())
        .then(data => {
          let bar = document.getElementById("progress-bar");
          bar.style.width = data.progress + "%";
          bar.innerText = data.progress + "%";

          if (data.state !== "COMPLETED" && data.state !== "FAILURE") {
            setTimeout(updateProgress, 2000);
          } else if (data.state === "COMPLETED") {
            bar.classList.remove("progress-bar-animated");
            bar.classList.add("bg-success");
            bar.innerText = "✅ Completed";
          } else if (data.state === "FAILURE" || data.state === "REVOKED") {
            bar.classList.remove("progress-bar-animated");
            bar.classList.add("bg-danger");
            bar.innerText = "❌ Failed";
            alert("OCR preprocessing failed. Please try again.");
          }
        })
        .catch(err => console.error("Error fetching task status:", err));
    }

    updateProgress();
  </script>
  {% endif %}

</div>
{% endblock %}
